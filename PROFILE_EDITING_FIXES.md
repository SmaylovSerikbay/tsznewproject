# Исправления проблемы с редактированием профиля

## Проблема

При редактировании профиля открывались разные окна редактирования, появлялись ошибки "выберите корректный город" и открывались дополнительные окна.

## Причины проблемы

1. **Дублирующие файлы**: Существовал дублирующий файл `profile-settings.html` с другим дизайном
2. **Несоответствие полей**: В модальном окне и основной странице использовались разные форматы для полей города и типов услуг
3. **Неправильная обработка данных**: View не корректно обрабатывал данные из разных форм

## Исправления

### 1. Удален дублирующий файл
- Удален файл `templates/profile-settings.html` (дублирующий дизайн)

### 2. Исправлено модальное окно редактирования
**Файл:** `templates/modals/edit_profile_modal.html`

**Изменения:**
- Исправлено поле города: теперь использует `city.name` вместо `city.id`
- Исправлено поле типов услуг: корректная проверка выбранных значений

```html
<!-- Было -->
<option value="{{ city.id }}" {% if user.city == city %}selected{% endif %}>

<!-- Стало -->
<option value="{{ city.name }}" {% if user.city and user.city.name == city.name %}selected{% endif %}>
```

### 3. Исправлена основная страница настроек
**Файл:** `templates/profile_settings.html`

**Изменения:**
- Исправлено поле типов услуг: теперь использует `service.id` вместо `service.code`

```html
<!-- Было -->
<option value="{{ service.code }}" {% if user.service_type and user.service_type.code == service.code %}selected{% endif %}>

<!-- Стало -->
<option value="{{ service.id }}" {% if user.service_type and user.service_type.id == service.id %}selected{% endif %}>
```

### 4. Обновлена логика обработки в View
**Файл:** `main/views.py`

**Изменения:**
- Добавлена поддержка как основного типа услуги (`service_type`), так и множественного выбора (`service_types`)
- Улучшена обработка ошибок
- Корректная работа с городами по имени

```python
# Обрабатываем тип услуги (может быть один или несколько)
service_type_id = request.POST.get('service_type')
service_types_ids = request.POST.getlist('service_types')

if service_type_id:
    # Устанавливаем основной тип услуги
    primary_service_type = ServiceType.objects.get(id=service_type_id)
    request.user.service_type = primary_service_type
elif service_types_ids:
    # Если основной тип не выбран, берем первый из списка
    primary_service_type = ServiceType.objects.get(id=service_types_ids[0])
    request.user.service_type = primary_service_type
```

## Структура редактирования профиля

### 1. Основная страница настроек
- **URL:** `/profile/settings/`
- **Файл:** `templates/profile_settings.html`
- **View:** `profile_settings`
- **Использование:** Полноценная страница с расширенными настройками

### 2. Модальное окно редактирования
- **ID:** `editProfileModal`
- **Файл:** `templates/modals/edit_profile_modal.html`
- **Использование:** Быстрое редактирование основных полей

### 3. Ссылки на редактирование
- В dashboard-performer: кнопка "Редактировать профиль" → модальное окно
- В header и mobile-menu: ссылка "Настройки профиля" → основная страница
- В profile.html: кнопка "Настройки профиля" → основная страница

## Тестирование

Создан тестовый скрипт `test_profile_editing.py` для проверки:
- Наличия пользователей
- Доступных городов и типов услуг
- Текущих настроек пользователей

### Запуск тестов:
```bash
python test_profile_editing.py
```

## Рекомендации

1. **Используйте основную страницу** для полного редактирования профиля
2. **Используйте модальное окно** для быстрого изменения основных полей
3. **Убедитесь в наличии данных** в базе (города, типы услуг)
4. **Проверяйте корректность** введенных данных перед сохранением

## Результат

После исправлений:
- ✅ Убрано дублирование окон редактирования
- ✅ Исправлены ошибки с городами
- ✅ Корректная работа с типами услуг
- ✅ Единообразная обработка данных
- ✅ Улучшена пользовательская логика

