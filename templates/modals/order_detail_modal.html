<!-- Order Detail Modal -->
<div id="orderDetailModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
  <!-- Desktop версия -->
  <div class="hidden md:flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal('orderDetailModal')"></div>
    
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    
                   <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-2 sm:align-middle sm:max-w-6xl sm:w-full">
        <div class="bg-white px-8 pt-8 pb-8 sm:p-10 sm:pb-10">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-gray-900" id="orderDetailTitle">Детали заявки</h2>
            <button onclick="closeModal('orderDetailModal')" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100">
              <i class="ri-close-line text-3xl"></i>
            </button>
          </div>
          
          <div id="orderDetailContent" class="overflow-y-auto pr-2">
            <!-- Контент будет загружаться динамически -->
          </div>
        </div>
      </div>
  </div>

           <!-- Mobile версия - снизу вверх -->
    <div class="md:hidden fixed inset-0 bg-black bg-opacity-50 flex items-end">
      <div class="w-full bg-white rounded-t-3xl shadow-xl transform transition-transform duration-300 max-h-[95vh] overflow-hidden">
        <!-- Хэндл для перетаскивания -->
        <div class="flex justify-center pt-3 pb-2">
          <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
        </div>
        
        <div class="px-4 pt-2 pb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-900" id="orderDetailTitleMobile">Детали заявки</h2>
            <button onclick="closeModal('orderDetailModal')" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100">
              <i class="ri-close-line text-xl"></i>
            </button>
          </div>
          
          <div id="orderDetailContentMobile" class="overflow-y-auto pr-1" style="max-height: calc(95vh - 100px);">
            <!-- Контент будет загружаться динамически -->
          </div>
        </div>
      </div>
    </div>
</div>

<script>
function openOrderDetailModal(orderId, action = 'view') {
  console.log('openOrderDetailModal called with:', orderId, action);
  
  const modal = document.getElementById('orderDetailModal');
  const title = document.getElementById('orderDetailTitle');
  const titleMobile = document.getElementById('orderDetailTitleMobile');
  const content = document.getElementById('orderDetailContent');
  const contentMobile = document.getElementById('orderDetailContentMobile');
  
  if (!modal) {
    console.error('Modal element not found!');
    return;
  }
  
  // Устанавливаем заголовок
  const titleText = action === 'respond' ? 'Откликнуться на заявку' : 'Детали заявки';
  title.textContent = titleText;
  titleMobile.textContent = titleText;
  
  if (action === 'respond') {
    // Для отклика показываем только форму
    showResponseForm(orderId);
    modal.classList.remove('hidden');
  } else {
    // Для просмотра деталей загружаем данные заявки
    const loadingHtml = `
      <div class="text-center py-16">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-6"></div>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">Загрузка данных</h3>
        <p class="text-gray-500">Пожалуйста, подождите...</p>
      </div>
    `;
    content.innerHTML = loadingHtml;
    contentMobile.innerHTML = loadingHtml;
    
    // Загружаем данные заявки
    fetch(`/order/${orderId}/detail/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Order data:', data.order); // Отладочная информация
          const htmlContent = generateOrderDetailHTML(data.order, action);
          content.innerHTML = htmlContent;
          contentMobile.innerHTML = htmlContent;
        } else {
          content.innerHTML = `
            <div class="text-center py-16">
              <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i class="ri-error-warning-line text-white text-4xl"></i>
              </div>
              <h3 class="text-2xl font-bold text-red-600 mb-4">Ошибка загрузки</h3>
              <p class="text-gray-600 text-lg">Не удалось загрузить данные заявки</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        content.innerHTML = `
          <div class="text-center py-16">
            <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
              <i class="ri-error-warning-line text-white text-4xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Ошибка загрузки</h3>
            <p class="text-gray-600 text-lg">Не удалось загрузить данные заявки</p>
          </div>
        `;
      });
    
    modal.classList.remove('hidden');
  }
}

function generateOrderDetailHTML(order, action) {
  console.log('Generating HTML for order:', order); // Отладочная информация
  console.log('is_customer:', order.is_customer); // Отладочная информация
  console.log('status:', order.status); // Отладочная информация
  console.log('services:', order.services); // Отладочная информация об услугах
  
  const eventTypeLabels = {
    'wedding': 'Свадьба',
    'birthday': 'День рождения',
    'corporate': 'Корпоратив',
    'anniversary': 'Юбилей',
    'graduation': 'Выпускной',
    'party': 'Вечеринка'
  };
  
  const statusLabels = {
    'new': 'Новый',
    'in_progress': 'В работе',
    'completed': 'Завершен',
    'cancelled': 'Отменен'
  };
  
  const statusColors = {
    'new': '#1976d2',
    'in_progress': '#2e7d32',
    'completed': '#7b1fa2',
    'cancelled': '#c62828'
  };
  
           return `
      <div class="space-y-6">
        <!-- Заголовок заявки -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
          <h3 class="text-xl font-bold text-gray-900 mb-2">${order.title}</h3>
          <div class="flex flex-wrap gap-4 text-sm text-gray-600">
            <span class="flex items-center bg-white px-2 py-1 rounded-full shadow-sm">
              <i class="ri-calendar-line mr-1 text-blue-500"></i> 
              ${eventTypeLabels[order.event_type] || order.event_type}
            </span>
            <span class="flex items-center bg-white px-2 py-1 rounded-full shadow-sm">
              <i class="ri-time-line mr-1 text-green-500"></i> 
              ${order.event_date}
            </span>
            <span class="flex items-center px-2 py-1 rounded-full text-white font-medium text-xs ${
              order.status === 'new' ? 'bg-blue-500' : 
              order.status === 'in_progress' ? 'bg-yellow-500' : 
              order.status === 'completed' ? 'bg-green-500' : 'bg-red-500'
            }">
              ${statusLabels[order.status] || order.status}
            </span>
          </div>
        </div>
        
        <!-- Основная информация -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
            <div class="text-xs font-semibold text-gray-700 mb-1 flex items-center">
              <i class="ri-map-pin-line mr-1 text-blue-500"></i> Город
            </div>
            <div class="text-gray-800 font-medium">${order.city}</div>
          </div>
          ${order.venue ? `
          <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
            <div class="text-xs font-semibold text-gray-700 mb-1 flex items-center">
              <i class="ri-building-line mr-1 text-purple-500"></i> Место
            </div>
            <div class="text-gray-800 font-medium">${order.venue}</div>
          </div>
          ` : ''}
          <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
            <div class="text-xs font-semibold text-gray-700 mb-1 flex items-center">
              <i class="ri-group-line mr-1 text-green-500"></i> Гостей
            </div>
            <div class="text-gray-800 font-medium">${order.guest_count}</div>
          </div>
          <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
            <div class="text-xs font-semibold text-gray-700 mb-1 flex items-center">
              <i class="ri-money-dollar-circle-line mr-1 text-yellow-500"></i> Бюджет
            </div>
            <div class="text-primary font-bold">${Number(order.budget).toLocaleString()} ₸</div>
          </div>
        </div>
      
                           <!-- Требуемые услуги -->
        ${order.services && order.services.length > 0 ? `
        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="ri-service-line mr-2 text-purple-500"></i> Требуемые услуги
          </h4>
          <div class="flex flex-wrap gap-2">
            ${order.services.map(service => `
              <span class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-sm">
                <i class="ri-checkbox-circle-line mr-1"></i> ${service}
              </span>
            `).join('')}
          </div>
        </div>
        ` : ''}
        
        <!-- Описание -->
        ${order.description ? `
        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="ri-file-text-line mr-2 text-blue-500"></i> Описание заявки
          </h4>
          <div class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-700 text-sm max-h-24 overflow-y-auto">
            ${order.description}
          </div>
        </div>
        ` : ''}
        
        <!-- Заказчик -->
        ${order.customer ? `
        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
          <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
            <i class="ri-user-line mr-2 text-green-500"></i> Заказчик
          </h4>
          <div class="flex items-center gap-3 p-3 bg-gray-50 rounded border border-gray-200">
            ${order.customer.profile_photo ? 
              `<img src="${order.customer.profile_photo}" alt="Фото заказчика" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm">` :
              `<div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center border-2 border-white shadow-sm">
                <i class="ri-user-line text-white text-lg"></i>
              </div>`
            }
            <div>
              <div class="text-base font-bold text-gray-900">${order.customer.name}</div>
              <div class="text-gray-600 flex items-center text-sm">
                <i class="ri-map-pin-line mr-1 text-gray-400"></i>
                ${order.customer.city || 'Город не указан'}
              </div>
            </div>
          </div>
        </div>
                ` : ''}
    </div>
  `;
}

function showResponseForm(orderId) {
  const content = document.getElementById('orderDetailContent');
  const contentMobile = document.getElementById('orderDetailContentMobile');
  
  const formHtml = `
    <div class="max-w-lg mx-auto">
      <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
        <div class="text-center mb-4">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-md">
            <i class="ri-send-plane-line text-white text-lg"></i>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-1">Откликнуться на заявку</h3>
          <p class="text-gray-500 text-sm">Предложите свои услуги</p>
        </div>
        
        <form id="responseForm" class="space-y-4">
          <div>
            <label class="block font-medium text-gray-700 mb-1 text-sm">Ваша цена (₸) *</label>
            <input type="number" id="responsePrice" name="price" required min="0" step="100"
                   class="w-full px-3 py-3 border border-gray-300 rounded-lg text-base focus:border-blue-500 focus:outline-none transition-colors"
                   placeholder="Введите цену"
                   oninput="window.currentResponsePrice = this.value.trim();"
                   onblur="window.currentResponsePrice = this.value.trim();">
          </div>
          
          <div>
            <label class="block font-medium text-gray-700 mb-1 text-sm">Сообщение</label>
            <textarea id="responseMessage" name="message" rows="4" 
                      class="w-full px-3 py-3 border border-gray-300 rounded-lg text-sm resize-vertical focus:border-blue-500 focus:outline-none transition-colors"
                      placeholder="Расскажите о своем опыте, услугах..."
                      oninput="window.currentResponseMessage = this.value.trim();"></textarea>
          </div>
          
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="closeModal('orderDetailModal')" class="flex-1 px-4 py-3 border border-gray-300 text-gray-600 rounded-lg font-medium text-sm hover:bg-gray-50 transition-colors">
              Отмена
            </button>
            <button type="button" onclick="submitResponseClick(${orderId})" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-lg font-medium text-sm hover:from-blue-600 hover:to-purple-700 transition-all shadow-sm hover:shadow-md">
              <i class="ri-send-plane-line mr-1"></i> Откликнуться
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
  
  if (content) {
    content.innerHTML = formHtml;
  }
  
  if (contentMobile) {
    contentMobile.innerHTML = formHtml;
  }
  

  

}

function submitResponseData(orderId, price, message, submitBtn) {
  console.log('submitResponseData called for orderId:', orderId, 'price:', price, 'message:', message);
  console.log('Price type:', typeof price, 'Price value:', price);
  console.log('Message type:', typeof message, 'Message value:', message);
  
  // Показываем индикатор загрузки
  const originalText = submitBtn ? submitBtn.innerHTML : '';
  if (submitBtn) {
    submitBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Отправка...';
    submitBtn.disabled = true;
  }
  
  console.log('Sending request with data:', { price, message });
  
  fetch(`/order/${orderId}/respond/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      price: parseFloat(price),
      message: message
    })
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      // Показываем успех для обеих версий (desktop и mobile)
      const successHtml = `
        <div class="text-center py-16">
          <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
            <i class="ri-check-line text-white text-4xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-green-600 mb-4">Отклик отправлен!</h3>
          <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">Заказчик получит уведомление о вашем отклике и свяжется с вами в ближайшее время</p>
          <button onclick="closeModal('orderDetailModal')" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-8 rounded-lg font-semibold text-lg hover:from-green-600 hover:to-green-700 transition-all shadow-md hover:shadow-lg">
            Закрыть
          </button>
        </div>
      `;
      
      // Обновляем контент для обеих версий
      const desktopContent = document.getElementById('orderDetailContent');
      const mobileContent = document.getElementById('orderDetailContentMobile');
      
      if (desktopContent) desktopContent.innerHTML = successHtml;
      if (mobileContent) mobileContent.innerHTML = successHtml;
      
      // Вызываем глобальную функцию успеха если она есть
      if (typeof window.onResponseSuccess === 'function') {
        window.onResponseSuccess();
      }
    } else {
      const errorMessage = data.error || data.message || 'Неизвестная ошибка';
      console.error('Server error:', errorMessage);
      alert('Ошибка: ' + errorMessage);
      if (submitBtn) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }
  })
  .catch(error => {
    console.error('Fetch error:', error);
    alert('Ошибка при отправке отклика: ' + error.message);
    if (submitBtn) {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
}

// Простая функция для обработки клика по кнопке отклика
function submitResponseClick(orderId) {
  // Получаем элементы формы - ищем во всех возможных местах
  let priceInput = document.getElementById('responsePrice');
  let messageInput = document.getElementById('responseMessage');
  
  // Если не нашли по ID, ищем по селектору
  if (!priceInput) {
    priceInput = document.querySelector('input[name="price"]');
  }
  
  if (!messageInput) {
    messageInput = document.querySelector('textarea[name="message"]');
  }
  
  // Если все еще не нашли, ищем в модальном окне
  if (!priceInput || !messageInput) {
    const modal = document.getElementById('orderDetailModal');
    if (modal) {
      if (!priceInput) {
        priceInput = modal.querySelector('input[name="price"]');
      }
      if (!messageInput) {
        messageInput = modal.querySelector('textarea[name="message"]');
      }
    }
  }
  
  if (!priceInput || !messageInput) {
    console.error('Form elements not found:', { priceInput, messageInput });
    alert('Ошибка: элементы формы не найдены. Попробуйте обновить страницу.');
    return;
  }
  

  
  // Получаем значения полей - пробуем разные способы
  let price = priceInput.value;
  let message = messageInput.value;
  
  // Если основной способ не работает, пробуем глобальные переменные
  if (!price || price === '') {
    price = window.currentResponsePrice || '';
  }
  
  // То же самое для сообщения
  if (!message || message === '') {
    message = window.currentResponseMessage || '';
  }
  
  // Если все еще не работает, пробуем альтернативные способы
  if (!price || price === '') {
    // Способ 1: через data-атрибут
    price = priceInput.getAttribute('data-current-value') || '';
    
    // Способ 2: через getAttribute
    if (!price || price === '') {
      price = priceInput.getAttribute('value') || '';
    }
    
    // Способ 3: через defaultValue
    if (!price || price === '') {
      price = priceInput.defaultValue || '';
    }
  }
  
  // Очищаем от пробелов
  price = price ? price.trim() : '';
  message = message ? message.trim() : '';
  
  // Проверяем, что цена указана
  if (!price || price === '' || price.length === 0) {
    alert('Пожалуйста, укажите цену');
    priceInput.focus();
    return;
  }
  
  // Проверяем, что цена является числом
  if (isNaN(price) || parseFloat(price) <= 0) {
    alert('Пожалуйста, укажите корректную цену');
    priceInput.focus();
    return;
  }
  
  // Находим кнопку для показа индикатора загрузки
  const submitBtn = document.querySelector('button[onclick*="submitResponseClick"]');
  
  // Отправляем отклик
  submitResponseData(orderId, price, message, submitBtn);
}

// Оставляем старую функцию для совместимости
function submitResponse(event, orderId) {
  event.preventDefault();
  
  console.log('submitResponse called for orderId:', orderId);
  
  // Получаем элементы формы
  const priceInput = document.getElementById('responsePrice');
  const messageInput = document.getElementById('responseMessage');
  const submitBtn = event.target.querySelector('button[type="submit"]');
  
  if (!priceInput || !messageInput || !submitBtn) {
    console.error('Form elements not found:', { priceInput, messageInput, submitBtn });
    alert('Ошибка: элементы формы не найдены');
    return;
  }
  
  const price = priceInput.value.trim();
  const message = messageInput.value.trim();
  
  console.log('Form values:', { price, message });
  
  // Проверяем, что цена указана
  if (!price || price === '') {
    alert('Пожалуйста, укажите цену');
    priceInput.focus();
    return;
  }
  
  // Проверяем, что цена является числом
  if (isNaN(price) || parseFloat(price) <= 0) {
    alert('Пожалуйста, укажите корректную цену');
    priceInput.focus();
    return;
  }
  
  // Используем новую функцию для отправки данных
  submitResponseData(orderId, price, message, submitBtn);
}



// Функция для получения CSRF токена
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// CSS для анимации загрузки
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Функция отмены заказа
function cancelOrder(orderId) {
  if (confirm('Вы уверены, что хотите отменить этот заказ?')) {
    fetch(`/order/${orderId}/performer-cancel/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('Заказ успешно отменен', 'success');
        // Перезагружаем страницу для обновления данных
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        showNotification('Ошибка при отмене заказа: ' + (data.error || 'Неизвестная ошибка'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Ошибка при отмене заказа', 'error');
    });
  }
}

// Функция удаления заказа
function deleteOrder(orderId) {
  if (confirm('Вы уверены, что хотите удалить этот заказ? Это действие нельзя отменить.')) {
    fetch(`/order/${orderId}/delete-api/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        showNotification('Заказ успешно удален', 'success');
        // Закрываем модальное окно и перезагружаем страницу
        closeModal('orderDetailModal');
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        showNotification('Ошибка при удалении заказа: ' + (data.error || 'Неизвестная ошибка'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Ошибка при удалении заказа: ' + error.message, 'error');
    });
  }
}

// Функция завершения заказа
function completeOrder(orderId) {
  if (confirm('Вы уверены, что хотите завершить этот заказ?')) {
    fetch(`/order/${orderId}/complete-api/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        showNotification('Заказ успешно завершен', 'success');
        // Закрываем модальное окно и перезагружаем страницу
        closeModal('orderDetailModal');
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        showNotification('Ошибка при завершении заказа: ' + (data.error || 'Неизвестная ошибка'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Ошибка при завершении заказа: ' + error.message, 'error');
    });
  }
}
</script> 