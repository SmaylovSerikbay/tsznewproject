<!-- Модальное окно для редактирования заказа -->
<div id="editOrderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center p-0 md:p-4 z-50 hidden">
  <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl w-full md:max-w-lg max-h-[90vh] md:max-h-[85vh] overflow-y-auto relative" onclick="event.stopPropagation()">
    <!-- Header -->
    <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 rounded-t-3xl">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="text-xl font-bold text-gray-900 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
              <i class="ri-edit-line text-white text-lg"></i>
            </div>
            Редактировать заявку
          </h3>
          <p class="text-gray-600 mt-1 text-sm">Внесите изменения в вашу заявку</p>
        </div>
        <button onclick="closeEditOrderModal()" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition-colors">
          <i class="ri-close-line text-gray-600 text-lg"></i>
        </button>
      </div>
    </div>

    <form id="editOrderForm" onsubmit="submitEditOrder(event)" class="p-6">
      {% csrf_token %}
      <input type="hidden" id="editOrderId" name="order_id">
      
      <!-- Основная информация -->
      <div class="space-y-4">
        <div>
          <label for="editOrderTitle" class="block text-sm font-semibold text-gray-700 mb-2">Название мероприятия *</label>
          <input type="text" id="editOrderTitle" name="title" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required 
                 placeholder="Например: Свадьба Али и Айши">
        </div>

        <div class="grid grid-cols-1 gap-4">
          <div>
            <label for="editEventType" class="block text-sm font-semibold text-gray-700 mb-2">Тип мероприятия *</label>
            <select id="editEventType" name="event_type" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required>
              <option value="">Выберите тип</option>
              <option value="wedding">Свадьба</option>
              <option value="birthday">День рождения</option>
              <option value="corporate">Корпоратив</option>
              <option value="anniversary">Юбилей</option>
              <option value="graduation">Выпускной</option>
              <option value="other">Другое</option>
            </select>
          </div>
          <div>
            <label for="editOrderCity" class="block text-sm font-semibold text-gray-700 mb-2">Город *</label>
            <select id="editOrderCity" name="city" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required>
              <option value="">Выберите город</option>
              {% for city in cities %}
                <option value="{{ city.name }}">{{ city.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div>
          <label for="editEventDate" class="block text-sm font-semibold text-gray-700 mb-2">Дата мероприятия *</label>
          <input type="date" id="editEventDate" name="event_date" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required>
        </div>

        <div>
          <label for="editVenue" class="block text-sm font-semibold text-gray-700 mb-2">Место проведения *</label>
          <input type="text" id="editVenue" name="venue" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required
                 placeholder="Адрес или название места проведения">
        </div>

        <div class="grid grid-cols-1 gap-4">
          <div>
            <label for="editGuestCount" class="block text-sm font-semibold text-gray-700 mb-2">Количество гостей *</label>
            <input type="number" id="editGuestCount" name="guest_count" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required min="1" placeholder="50">
          </div>
          <div>
            <label for="editBudget" class="block text-sm font-semibold text-gray-700 mb-2">Бюджет (₸) *</label>
            <input type="number" id="editBudget" name="budget" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" required min="0" placeholder="100000">
          </div>
        </div>

        <!-- Услуги -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-3">Нужные услуги</label>
          <div class="grid grid-cols-1 gap-2" id="editServicesContainer">
            {% for service in service_types %}
            <label class="service-option cursor-pointer">
              <input type="checkbox" name="services" value="{{ service.code }}" class="hidden">
              <div class="border-2 border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:bg-blue-50 transition-all duration-300">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="{{ service.icon|default:'ri-service-line' }} text-blue-600"></i>
                  </div>
                  <div class="flex-1">
                    <div class="font-medium text-gray-900">{{ service.name }}</div>
                  </div>
                  <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center service-checkbox">
                    <i class="ri-check-line text-white text-sm hidden"></i>
                  </div>
                </div>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div>
          <label for="editDescription" class="block text-sm font-semibold text-gray-700 mb-2">Описание</label>
          <textarea id="editDescription" name="description" rows="4" class="w-full px-3 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300" placeholder="Дополнительная информация о мероприятии"></textarea>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3 mt-8">
        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
          <i class="ri-save-line mr-2"></i>
          Сохранить изменения
        </button>
        <button type="button" onclick="closeEditOrderModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-200 transition-colors font-semibold">
          <i class="ri-close-line mr-2"></i>
          Отмена
        </button>
      </div>
    </form>
  </div>
</div>

<style>
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}
</style>

<script>
// Функция для получения CSRF токена
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Функция уведомлений
function showNotification(message, type = 'info') {
  // Создаем элемент уведомления
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  
  if (type === 'success') {
    notification.style.background = '#28a745';
  } else if (type === 'error') {
    notification.style.background = '#dc3545';
  } else {
    notification.style.background = '#17a2b8';
  }
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // Удаляем через 3 секунды
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

// Функции для работы с модальным окном редактирования
function openEditOrderModal(orderId) {
  // Загружаем данные заказа
  fetch(`/order/${orderId}/edit/`, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const order = data.order;
        
        // Заполняем форму данными
        document.getElementById('editOrderId').value = orderId;
        document.getElementById('editOrderTitle').value = order.title;
        document.getElementById('editEventType').value = order.event_type;
        document.getElementById('editOrderCity').value = order.city;
        document.getElementById('editEventDate').value = order.event_date;
        document.getElementById('editVenue').value = order.venue;
        document.getElementById('editGuestCount').value = order.guest_count;
        document.getElementById('editBudget').value = order.budget; // Устанавливаем budget
        document.getElementById('editDescription').value = order.description || '';
        
        // Устанавливаем выбранные услуги
        const serviceCheckboxes = document.querySelectorAll('#editServicesContainer input[type="checkbox"]');
        serviceCheckboxes.forEach(checkbox => {
          // Проверяем, есть ли код услуги в списке кодов услуг заказа
          checkbox.checked = order.services_codes && order.services_codes.includes(checkbox.value);
          updateServiceCheckbox(checkbox);
        });
        
        // Показываем модальное окно
        document.getElementById('editOrderModal').classList.remove('hidden');
      } else {
        showNotification('Ошибка загрузки данных заказа', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Ошибка загрузки данных заказа', 'error');
    });
}

function closeEditOrderModal() {
  document.getElementById('editOrderModal').classList.add('hidden');
  document.getElementById('editOrderForm').reset();
}

function submitEditOrder(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const orderId = formData.get('order_id');
  
  // Собираем выбранные услуги
  const selectedServices = [];
  document.querySelectorAll('#editServicesContainer input[type="checkbox"]:checked').forEach(checkbox => {
    selectedServices.push(checkbox.value);
  });
  
  // Добавляем услуги к форме
  formData.delete('services');
  selectedServices.forEach(service => {
    formData.append('services', service);
  });
  
  // Отправляем запрос
  fetch(`/order/${orderId}/edit/`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Заявка успешно обновлена!', 'success');
      closeEditOrderModal();
      setTimeout(() => { location.reload(); }, 1000);
    } else {
      showNotification('Ошибка при обновлении заявки: ' + (data.message || 'Неизвестная ошибка'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Ошибка при обновлении заявки', 'error');
  });
}

// Обновление состояния чекбоксов услуг
function updateServiceCheckbox(checkbox) {
  const option = checkbox.closest('.service-option');
  const checkboxDiv = option.querySelector('.service-checkbox');
  const checkIcon = option.querySelector('.ri-check-line');
  
  if (checkbox.checked) {
    checkboxDiv.classList.add('bg-blue-500', 'border-blue-500');
    checkIcon.classList.remove('hidden');
  } else {
    checkboxDiv.classList.remove('bg-blue-500', 'border-blue-500');
    checkIcon.classList.add('hidden');
  }
}

// Обработка кликов по услугам
document.addEventListener('DOMContentLoaded', function() {
  const serviceOptions = document.querySelectorAll('#editServicesContainer .service-option');
  
  serviceOptions.forEach(option => {
    const checkbox = option.querySelector('input[type="checkbox"]');
    
    option.addEventListener('click', function() {
      checkbox.checked = !checkbox.checked;
      updateServiceCheckbox(checkbox);
    });
  });
});
</script>
