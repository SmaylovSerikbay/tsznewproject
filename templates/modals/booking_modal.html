<!-- Booking Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <button class="modal-close" onclick="closeBookingModal()">
      <i class="ri-close-line"></i>
    </button>
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="ri-calendar-check-line"></i>
        Забронировать исполнителя
      </h2>
    </div>
    <form id="bookingForm" method="POST">
      {% csrf_token %}
             <input type="hidden" name="performer_id" id="performerId">
       <input type="hidden" name="event_date" id="eventDate">
       
       <!-- Tariff Selection -->
      <div class="form-group">
        <label class="form-label">
          <i class="ri-price-tag-3-line"></i>
          Выберите тариф
        </label>
        <select name="tariff" class="form-input" id="tariffSelect" required>
          <option value="">Загрузка тарифов...</option>
        </select>
      </div>

      <!-- Existing Order Selection -->
      <div class="form-group">
        <label class="form-label">
          <i class="ri-file-list-line"></i>
          Прикрепить существующую заявку (опционально)
        </label>
        <select name="existing_order" class="form-input" id="existingOrderSelect">
          <option value="">Создать новую заявку</option>
          <option value="">Загрузка заявок...</option>
        </select>
      </div>

             <!-- Date Selection -->
       <div class="form-group">
         <label class="form-label">
           <i class="ri-calendar-line"></i>
           Дата мероприятия
         </label>
         <div class="date-selection-container">
           <button type="button" class="date-select-btn" onclick="openDatePicker()">
             <i class="ri-calendar-line"></i>
             <span id="dateSelectText">Выберите дату</span>
           </button>
           <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
             <i class="ri-calendar-check-line"></i>
             <span>Выбранная дата: <strong id="selectedDateText"></strong></span>
           </div>
         </div>
       </div>

      <!-- Details -->
      <div class="form-group">
        <label class="form-label">
          <i class="ri-file-text-line"></i>
          Дополнительная информация
        </label>
        <textarea name="details" class="form-input" rows="4" placeholder="Опишите детали вашего мероприятия..."></textarea>
      </div>

      <div class="form-footer">
        <button type="button" class="btn outline" onclick="closeBookingModal()">Отмена</button>
        <button type="submit" class="btn accent">Забронировать</button>
      </div>
    </form>
  </div>
</div>

<!-- Date Picker Modal -->
<div id="datePickerModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <button class="modal-close" onclick="closeDatePicker()">
      <i class="ri-close-line"></i>
    </button>
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="ri-calendar-line"></i>
        Выберите дату
      </h2>
    </div>
    <div class="calendar-preview" id="calendarPreview">
      <div class="calendar-header">
        <button type="button" class="calendar-nav-btn" onclick="prevMonth()">
          <i class="ri-arrow-left-s-line"></i>
        </button>
        <span id="currentMonthDisplay" class="calendar-month"></span>
        <button type="button" class="calendar-nav-btn" onclick="nextMonth()">
          <i class="ri-arrow-right-s-line"></i>
        </button>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be generated by JavaScript -->
      </div>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color available"></span>
          <span>Свободен</span>
        </div>
        <div class="legend-item">
          <span class="legend-color busy"></span>
          <span>Занят</span>
        </div>
        <div class="legend-item">
          <span class="legend-color selected"></span>
          <span>Выбрано</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 24px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-close {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--gray-500);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.modal-close:hover {
  color: var(--gray-700);
  background: var(--gray-100);
}

.modal-header {
  margin-bottom: 24px;
  padding-right: 40px;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-title i {
  color: var(--primary);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.form-label i {
  color: var(--primary);
}

.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 0.875rem;
  color: var(--gray-900);
  background: white;
  transition: all 0.2s;
}

.form-input:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
}



.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s;
  border: none;
  cursor: pointer;
}

.btn.outline {
  background: transparent;
  color: var(--gray-600);
  border: 1px solid var(--gray-300);
}

.btn.outline:hover {
  border-color: var(--gray-500);
  color: var(--gray-700);
}

.btn.accent {
  background: var(--primary);
  color: white;
}

.btn.accent:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.form-footer {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.form-footer .btn {
  flex: 1;
}

@media (max-width: 768px) {
  .modal-content {
    width: 95%;
    padding: 20px;
  }
  

  
  .btn {
    width: 100%;
    justify-content: center;
  }
}

.form-footer {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.form-footer .btn {
  flex: 1;
}

/* Calendar Styles */
.calendar-preview {
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 16px;
  background: var(--gray-50);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.calendar-nav-btn {
  background: none;
  border: none;
  color: var(--gray-600);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  background: var(--gray-200);
  color: var(--gray-900);
}

.calendar-month {
  font-weight: 600;
  color: var(--gray-900);
  font-size: 0.9rem;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 12px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.calendar-day:hover {
  background: var(--gray-200);
}

.calendar-day.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.calendar-day.busy {
  background: #fee2e2;
  color: #dc2626;
  border-color: #fecaca;
}

.calendar-day.past {
  color: var(--gray-400);
  cursor: not-allowed;
}

.calendar-day.other-month {
  color: var(--gray-400);
}

.calendar-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.75rem;
  color: var(--gray-600);
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.legend-color.available {
  background: var(--gray-200);
}

.legend-color.busy {
  background: #fee2e2;
  border: 1px solid #fecaca;
}

.legend-color.selected {
  background: var(--primary);
}

.selected-date-display {
  background: var(--primary-light);
  border: 1px solid var(--primary);
  border-radius: 8px;
  padding: 12px;
  margin: 12px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--primary-dark);
  font-weight: 500;
}

.selected-date-display i {
  color: var(--primary);
  font-size: 1.1rem;
}

/* Date Selection Styles */
.date-selection-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.date-select-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border: 2px dashed var(--gray-300);
  border-radius: 8px;
  background: var(--gray-50);
  color: var(--gray-600);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  justify-content: center;
}

.date-select-btn:hover {
  border-color: var(--primary);
  background: var(--primary-light);
  color: var(--primary-dark);
}

.date-select-btn i {
  color: var(--primary);
  font-size: 1.1rem;
}
</style>

<script>
let currentCalendarDate = new Date();
let busyDates = new Set();

function openBookingModal(performerId) {
  document.getElementById('performerId').value = performerId;
  document.getElementById('bookingModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Сбрасываем выбранную дату
  document.getElementById('eventDate').value = '';
  document.getElementById('selectedDateDisplay').style.display = 'none';
  document.getElementById('dateSelectText').textContent = 'Выберите дату';
  
  // Load tariffs and other data
  loadTariffs(performerId);
  loadExistingOrders();
  loadBusyDates(performerId);
}

function closeBookingModal() {
  document.getElementById('bookingModal').style.display = 'none';
  document.body.style.overflow = 'auto';
  document.getElementById('bookingForm').reset();
  document.getElementById('selectedDateDisplay').style.display = 'none';
}

function openDatePicker() {
  document.getElementById('datePickerModal').style.display = 'block';
  renderCalendar();
}

function closeDatePicker() {
  document.getElementById('datePickerModal').style.display = 'none';
}

function loadTariffs(performerId) {
  fetch(`/api/performer/${performerId}/tariffs/`)
    .then(response => response.json())
    .then(data => {
      const tariffSelect = document.getElementById('tariffSelect');
      tariffSelect.innerHTML = '<option value="">Выберите тариф...</option>';
      
      data.tariffs.forEach(tariff => {
        const option = document.createElement('option');
        option.value = tariff.id;
        option.textContent = `${tariff.name} - ${tariff.price} ₸`;
        tariffSelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error loading tariffs:', error);
      document.getElementById('tariffSelect').innerHTML = '<option value="">Ошибка загрузки тарифов</option>';
    });
}

// Handle form submission
document.getElementById('bookingForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  // Отладочная информация
  console.log('DEBUG: Отправляемая дата:', data.event_date);
  console.log('DEBUG: Текущая дата:', new Date().toISOString().split('T')[0]);
  console.log('DEBUG: Существующая заявка:', data.existing_order);
  console.log('DEBUG: Тариф:', data.tariff);
  
  // Проверяем, что дата выбрана
  if (!data.event_date) {
    alert('Пожалуйста, выберите дату мероприятия из календаря');
    return;
  }
  
  // Проверяем, что выбран тариф
  if (!data.tariff) {
    alert('Пожалуйста, выберите тариф');
    return;
  }
  
  // Если выбрана существующая заявка, используем её данные
  if (data.existing_order) {
    data.use_existing_order = true;
  }
  
  // Создаем FormData для отправки
  const bookingFormData = new FormData();
  bookingFormData.append('event_date', data.event_date);
  bookingFormData.append('tariff', data.tariff);
  bookingFormData.append('details', data.details || '');
  if (data.existing_order && data.existing_order !== '') {
    bookingFormData.append('order_id', data.existing_order);
    console.log('DEBUG: Прикрепляем к заявке ID:', data.existing_order);
  } else {
    console.log('DEBUG: Создаем новую заявку');
  }
  
  fetch(`/create-order/${data.performer_id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: bookingFormData
  })
  .then(response => {
    if (response.ok) {
      // Успешное бронирование
      closeBookingModal();
      alert('Бронирование успешно отправлено!');
      setTimeout(() => {
        window.location.href = '/dashboard/';
      }, 1500);
    } else {
      // Ошибка
      return response.text().then(text => {
        alert('Ошибка при бронировании. Пожалуйста, попробуйте еще раз.');
      });
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Произошла ошибка при бронировании');
  });
});

// Load existing orders for the current user
function loadExistingOrders() {
  const orderSelect = document.getElementById('existingOrderSelect');
  orderSelect.innerHTML = '<option value="">Создать новую заявку</option>';
  
  fetch('/api/user/orders/')
    .then(response => response.json())
    .then(data => {
      console.log('DEBUG: Загруженные заявки:', data);
      if (data.orders && data.orders.length > 0) {
        data.orders.forEach(order => {
          // Показываем только заявки, которые не завершены
          if (order.status !== 'completed' && order.status !== 'cancelled') {
            const option = document.createElement('option');
            option.value = order.id;
            option.textContent = `${order.title} - ${order.event_date} (${order.status})`;
            orderSelect.appendChild(option);
          }
        });
      }
    })
    .catch(error => {
      console.error('Error loading orders:', error);
    });
}

// Load busy dates for performer
function loadBusyDates(performerId) {
  fetch(`/api/performer/${performerId}/busy-dates/`)
    .then(response => response.json())
    .then(data => {
      busyDates.clear();
      if (data.busy_dates) {
        data.busy_dates.forEach(date => {
          busyDates.add(date);
        });
      }
      renderCalendar();
    })
    .catch(error => {
      console.error('Error loading busy dates:', error);
    });
}

// Calendar functions
function renderCalendar() {
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();
  
  document.getElementById('currentMonthDisplay').textContent = 
    `${getMonthName(month)} ${year}`;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  
  let firstDayIndex = firstDay.getDay() || 7;
  firstDayIndex--;
  
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';
  
  // Add empty cells for days before the first day of month
  for (let i = 0; i < firstDayIndex; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day other-month';
    grid.appendChild(emptyCell);
  }
  
  // Add days of the month
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;
    
    const dateString = formatDate(new Date(year, month, day));
    const today = new Date();
    const currentDate = new Date(year, month, day);
    
    if (currentDate < today) {
      dayElement.classList.add('past');
    } else if (busyDates.has(dateString)) {
      dayElement.classList.add('busy');
    }
    
    dayElement.onclick = () => selectDate(dateString);
    grid.appendChild(dayElement);
  }
}

function selectDate(dateString) {
  const today = new Date();
  const selectedDate = new Date(dateString);
  
  if (selectedDate < today) {
    return; // Can't select past dates
  }
  
  if (busyDates.has(dateString)) {
    alert('Эта дата занята исполнителем');
    return;
  }
  
  document.getElementById('eventDate').value = dateString;
  
  // Обновляем текст кнопки
  const dateSelectText = document.getElementById('dateSelectText');
  const formattedDate = formatDateForDisplay(selectedDate);
  dateSelectText.textContent = formattedDate;
  
  // Показываем выбранную дату
  const selectedDateDisplay = document.getElementById('selectedDateDisplay');
  const selectedDateText = document.getElementById('selectedDateText');
  selectedDateText.textContent = formattedDate;
  selectedDateDisplay.style.display = 'flex';
  
  // Update calendar selection
  const days = document.querySelectorAll('.calendar-day');
  days.forEach(day => day.classList.remove('selected'));
  
  const selectedDay = Array.from(days).find(day => {
    const dayText = day.textContent;
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const dayDate = new Date(year, month, parseInt(dayText));
    return formatDate(dayDate) === dateString;
  });
  
  if (selectedDay) {
    selectedDay.classList.add('selected');
  }
  
  // Закрываем модальное окно календаря
  closeDatePicker();
}

function prevMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
  renderCalendar();
}

function getMonthName(month) {
  const months = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];
  return months[month];
}

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(date) {
  const months = [
    'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
    'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
  ];
  const day = date.getDate();
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${day} ${month} ${year}`;
}





// Close modal on background click
document.getElementById('bookingModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeBookingModal();
  }
});

// Close date picker modal on background click
document.getElementById('datePickerModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDatePicker();
  }
});

// Close date picker modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('datePickerModal').style.display === 'block') {
      closeDatePicker();
    } else if (document.getElementById('bookingModal').style.display === 'block') {
      closeBookingModal();
    }
  }
});
</script> 