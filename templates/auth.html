{% extends 'base.html' %}
{% load static %}

{% block title %}Вход и регистрация — Той со звездой{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-12">
    <!-- Main Content -->
    <div class="container mx-auto px-6">
        <div class="max-w-6xl mx-auto">
            <!-- Auth Container -->
            <div class="grid lg:grid-cols-2 gap-12 items-start">
                <!-- Left Column - Auth Forms -->
                <div class="bg-white rounded-3xl shadow-2xl p-8 lg:p-12">
                    {% if messages %}
                        <div class="mb-8">
                            {% for message in messages %}
                                <div class="bg-{{ message.tags }}-50 border-l-4 border-{{ message.tags }} p-4 mb-3 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="ri-{% if message.tags == 'success' %}check-line text-green-500{% elif message.tags == 'error' %}error-warning-line text-red-500{% else %}information-line text-blue-500{% endif %} mr-3 text-xl"></i>
                                        <span class="text-{{ message.tags }}-700 font-medium">{{ message }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Phone Number Form -->
                    <form method="post" id="phoneForm" class="space-y-8" {% if is_register %}style="display: none;"{% endif %}>
                        {% csrf_token %}
                        <input type="hidden" name="step" value="phone">
                        
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-whatsapp-line text-white text-2xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Введите номер WhatsApp</h2>
                            <p class="text-gray-600">Код подтверждения будет отправлен в WhatsApp</p>
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label for="phone_number" class="block text-sm font-semibold text-gray-700 mb-3">
                                Номер WhatsApp
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="ri-whatsapp-line text-gray-400 text-xl"></i>
                                </div>
                                <input 
                                    type="tel" 
                                    id="phone_number" 
                                    name="phone_number" 
                                    value="{{ form.phone_number.value|default:'' }}"
                                    class="block w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-500 text-lg transition-all duration-300"
                                    placeholder="+7 (777) 777-77-77"
                                    required
                                >
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                <i class="ri-information-line mr-1"></i>
                                Введите номер в международном формате (например: +7 777 777 77 77)
                            </p>
                            {% if form.phone_number.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.phone_number.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-blue-100 shadow-lg">
                            <i class="ri-login-box-line mr-3"></i>
                            Получить код
                        </button>
                    </form>

                    <!-- OTP Form -->
                    <form method="post" id="otpForm" class="space-y-8 hidden" {% if is_register %}style="display: none;"{% endif %}>
                        {% csrf_token %}
                        <input type="hidden" name="step" value="otp">
                        <input type="hidden" name="phone_number" id="otpPhoneNumber">
                        
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-whatsapp-line text-white text-2xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Введите код подтверждения</h2>
                            <p class="text-gray-600" id="otpInfoText">Код отправлен в WhatsApp на ваш номер</p>
                        </div>

                        <!-- OTP Input -->
                        <div>
                            <label for="otp_code" class="block text-sm font-semibold text-gray-700 mb-3">
                                Код подтверждения
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="ri-shield-keyhole-line text-gray-400 text-xl"></i>
                                </div>
                                <input 
                                    type="text" 
                                    id="otp_code" 
                                    name="otp_code" 
                                    class="block w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-500 text-lg text-center tracking-widest font-mono"
                                    placeholder="000000"
                                    maxlength="6"
                                    required
                                >
                            </div>
                            {% if form.otp_code.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.otp_code.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:from-green-700 hover:to-green-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-green-100 shadow-lg">
                            <i class="ri-check-line mr-3"></i>
                            Подтвердить
                        </button>

                        <!-- Back to Phone -->
                        <button type="button" onclick="showPhoneForm()" class="w-full bg-gray-50 text-gray-700 py-3 px-6 rounded-xl font-medium text-lg hover:bg-gray-100 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-100 border-2 border-gray-200">
                            <i class="ri-arrow-left-line mr-2"></i>
                            Изменить номер
                        </button>
                    </form>

                    <!-- Registration Form -->
                    {% if is_register %}
                    <form method="post" id="registerForm" class="space-y-8" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="phone_number" value="{{ request.session.verified_phone|default:'' }}">
                        
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-user-add-line text-white text-2xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Завершите регистрацию</h2>
                            <p class="text-gray-600">Заполните данные для создания аккаунта</p>
                        </div>

                        <!-- User Type Selection -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-4">Тип пользователя *</label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all duration-300 group">
                                    <input type="radio" name="user_type" value="customer" class="mr-3 w-5 h-5 text-blue-600" required>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900 group-hover:text-blue-700">Заказчик</div>
                                        <div class="text-sm text-gray-500">Ищу исполнителей</div>
                                    </div>
                                    <i class="ri-user-line text-gray-400 group-hover:text-blue-500 text-xl"></i>
                                </label>
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all duration-300 group">
                                    <input type="radio" name="user_type" value="performer" class="mr-3 w-5 h-5 text-blue-600" required>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900 group-hover:text-blue-700">Исполнитель</div>
                                        <div class="text-sm text-gray-500">Предоставляю услуги</div>
                                    </div>
                                    <i class="ri-user-star-line text-gray-400 group-hover:text-blue-500 text-xl"></i>
                                </label>
                            </div>
                        </div>

                        <!-- Name Fields -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="first_name" class="block text-sm font-semibold text-gray-700 mb-3">Имя *</label>
                                <input type="text" id="first_name" name="first_name" required
                                       class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300">
                            </div>
                            <div>
                                <label for="last_name" class="block text-sm font-semibold text-gray-700 mb-3">Фамилия *</label>
                                <input type="text" id="last_name" name="last_name" required
                                       class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300">
                            </div>
                        </div>

                        <!-- City Selection -->
                        <div>
                            <label for="city" class="block text-sm font-semibold text-gray-700 mb-3">Город *</label>
                            <select id="city" name="city" required
                                    class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300">
                                <option value="">Выберите город</option>
                                {% for city in cities %}
                                    <option value="{{ city.name }}">{{ city.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Service Type (for performers) -->
                        <div id="serviceTypeSection" class="hidden">
                            <label for="service_type" class="block text-sm font-semibold text-gray-700 mb-3">Специализация *</label>
                            <select id="service_type" name="service_type"
                                    class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300">
                                <option value="">Выберите специализацию</option>
                                {% for service in service_types %}
                                    <option value="{{ service.code }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Company Name (for performers) -->
                        <div id="companyNameSection" class="hidden">
                            <label for="company_name" class="block text-sm font-semibold text-gray-700 mb-3">Название компании</label>
                            <input type="text" id="company_name" name="company_name"
                                   class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300"
                                   placeholder="Необязательно">
                        </div>

                        <!-- Bio (for performers) -->
                        <div id="bioSection" class="hidden">
                            <label for="bio" class="block text-sm font-semibold text-gray-700 mb-3">О себе</label>
                            <textarea id="bio" name="bio" rows="4"
                                      class="block w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all duration-300 resize-none"
                                      placeholder="Расскажите о себе и своих услугах..."></textarea>
                        </div>

                        <!-- Profile Photo -->
                        <div>
                            <label for="profile_photo" class="block text-sm font-semibold text-gray-700 mb-3">Фото профиля</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors duration-300">
                                <input type="file" id="profile_photo" name="profile_photo" accept="image/*" class="hidden">
                                <label for="profile_photo" class="cursor-pointer">
                                    <i class="ri-camera-line text-3xl text-gray-400 mb-2 block"></i>
                                    <p class="text-gray-600">Нажмите для выбора фото или перетащите файл</p>
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-purple-100 shadow-lg">
                            <i class="ri-user-add-line mr-3"></i>
                            Завершить регистрацию
                        </button>
                    </form>
                    {% endif %}

                    <!-- Terms -->
                    <div class="mt-8 text-center">
                        <p class="text-sm text-gray-500">
                            Нажимая кнопки выше, вы соглашаетесь с 
                            <a href="#" class="text-blue-600 hover:text-blue-700 font-medium underline">условиями использования</a>
                        </p>
                    </div>
                </div>

                <!-- Right Column - Features & Benefits -->
                <div class="space-y-8">
                    <!-- Features -->
                    <div class="bg-white rounded-3xl shadow-2xl p-8 lg:p-12">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">Почему выбирают нас?</h3>
                        <div class="space-y-6">
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ri-shield-check-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Безопасные сделки</h4>
                                    <p class="text-gray-600 text-sm">Все исполнители проверены и имеют рейтинги</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ri-time-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Быстрый поиск</h4>
                                    <p class="text-gray-600 text-sm">Найдите исполнителя за несколько минут</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ri-star-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Лучшие исполнители</h4>
                                    <p class="text-gray-600 text-sm">Только проверенные профессионалы</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="ri-customer-service-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-1">Поддержка 24/7</h4>
                                    <p class="text-gray-600 text-sm">Мы всегда готовы помочь вам</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-3xl shadow-2xl p-8 lg:p-12 text-white">
                        <h3 class="text-2xl font-bold mb-6 text-center">Наши достижения</h3>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold mb-2">1000+</div>
                                <div class="text-blue-100 text-sm">Довольных клиентов</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold mb-2">500+</div>
                                <div class="text-blue-100 text-sm">Проверенных исполнителей</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold mb-2">50+</div>
                                <div class="text-blue-100 text-sm">Городов Казахстана</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold mb-2">4.9</div>
                                <div class="text-blue-100 text-sm">Средний рейтинг</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showOtpForm(phoneNumber) {
    const phoneForm = document.getElementById('phoneForm');
    const otpForm = document.getElementById('otpForm');
    const otpPhoneNumber = document.getElementById('otpPhoneNumber');
    const otpInfoText = document.getElementById('otpInfoText');
    
    if (phoneForm) phoneForm.classList.add('hidden');
    if (otpForm) otpForm.classList.remove('hidden');
    if (otpPhoneNumber) otpPhoneNumber.value = phoneNumber;
    if (otpInfoText) otpInfoText.textContent = `Код отправлен в WhatsApp на номер ${phoneNumber}`;
    
    // Автоматически фокусируемся на поле ввода кода
    setTimeout(() => {
        const otpInput = document.getElementById('otp_code');
        if (otpInput) {
            otpInput.focus();
        }
    }, 100);
}

function showPhoneForm() {
    const otpForm = document.getElementById('otpForm');
    const phoneForm = document.getElementById('phoneForm');
    
    if (otpForm) otpForm.classList.add('hidden');
    if (phoneForm) phoneForm.classList.remove('hidden');
}

// Handle phone form submission
const phoneForm = document.getElementById('phoneForm');
if (phoneForm) {
    phoneForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const phoneNumberInput = document.getElementById('phone_number');
        const phoneNumber = phoneNumberInput ? phoneNumberInput.value : '';
        
        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="ri-loader-4-line mr-3 animate-spin"></i>Отправляем...';
        submitButton.disabled = true;
        
        // Submit form via AJAX
        fetch('{% url "main:auth" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams(new FormData(this))
        })
        .then(response => {
            showOtpForm(phoneNumber);
            console.log('Phone number submitted successfully');
        })
        .catch(error => {
            console.error('Error submitting phone number:', error);
            showOtpForm(phoneNumber);
        })
        .finally(() => {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        });
    });
}

// Auto-focus OTP input when shown
const otpForm = document.getElementById('otpForm');
if (otpForm) {
    otpForm.addEventListener('transitionend', function() {
        if (!this.classList.contains('hidden')) {
            const otpInput = document.getElementById('otp_code');
            if (otpInput) {
                otpInput.focus();
            }
        }
    });
}

// Check if we should show OTP form on page load
document.addEventListener('DOMContentLoaded', function() {
    const otpErrors = document.querySelector('#otpForm .text-red-600');
    const phoneNumber = document.getElementById('otpPhoneNumber');
    
    if (otpErrors || (phoneNumber && phoneNumber.value)) {
        showOtpForm(phoneNumber ? phoneNumber.value : '');
    }

    // Registration form functionality
    const userTypeRadios = document.querySelectorAll('input[name="user_type"]');
    const serviceTypeSection = document.getElementById('serviceTypeSection');
    const companyNameSection = document.getElementById('companyNameSection');
    const bioSection = document.getElementById('bioSection');
    const serviceTypeSelect = document.getElementById('service_type');

    userTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'performer') {
                serviceTypeSection.classList.remove('hidden');
                companyNameSection.classList.remove('hidden');
                bioSection.classList.remove('hidden');
                serviceTypeSelect.required = true;
            } else {
                serviceTypeSection.classList.add('hidden');
                companyNameSection.classList.add('hidden');
                bioSection.classList.add('hidden');
                serviceTypeSelect.required = false;
            }
        });
    });

    // File input styling
    const fileInput = document.getElementById('profile_photo');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const fileName = this.files[0]?.name;
            if (fileName) {
                const label = this.parentElement.querySelector('p');
                label.textContent = `Выбрано: ${fileName}`;
            }
        });
    }
});
</script>

<style>
/* Custom animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fadeInUp {
    animation: fadeInUp 0.6s ease-out;
}

/* Input focus styles */
input:focus,
select:focus,
textarea:focus {
    outline: none;
    transform: translateY(-1px);
}

/* Button hover effects */
button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

/* File input styling */
input[type="file"] {
    cursor: pointer;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .grid-cols-2 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %} 