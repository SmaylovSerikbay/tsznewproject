{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}{{ order.title }} — Той со звездой{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="javascript:history.back()" class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium">
                <i class="ri-arrow-left-line mr-2"></i>
                Назад
            </a>
        </div>

        <!-- Order Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ order.title }}</h1>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                        <span class="inline-flex items-center">
                            <i class="ri-calendar-line mr-1"></i>
                            {{ order.event_date|date:"d.m.Y" }}
                        </span>
                        <span class="inline-flex items-center">
                            <i class="ri-map-pin-line mr-1"></i>
                            {{ order.city|default:"Город не указан" }}
                        </span>
                        <span class="inline-flex items-center">
                            <i class="ri-file-list-line mr-1"></i>
                            {{ order.get_event_type_display }}
                        </span>
                    </div>
                </div>
                <div class="ml-4">
                    {% if order.status == 'pending' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <i class="ri-time-line mr-1"></i>
                            В ожидании
                        </span>
                    {% elif order.status == 'in_progress' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                            <i class="ri-play-circle-line mr-1"></i>
                            В работе
                        </span>
                    {% elif order.status == 'completed' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <i class="ri-check-line mr-1"></i>
                            Завершено
                        </span>
                    {% elif order.status == 'cancelled' %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                            <i class="ri-close-line mr-1"></i>
                            Отменено
                        </span>
                    {% endif %}
        </div>
      </div>
    </div>

        <!-- Order Details -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Event Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-information-line mr-2 text-blue-600"></i>
                        Информация о мероприятии
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="ri-map-pin-line text-gray-400 mr-3 text-lg"></i>
            <div>
                                <p class="text-sm font-medium text-gray-900">Город</p>
                                <p class="text-sm text-gray-600">{{ order.city|default:"Не указан" }}</p>
            </div>
          </div>
          {% if order.venue %}
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="ri-building-line text-gray-400 mr-3 text-lg"></i>
            <div>
                                <p class="text-sm font-medium text-gray-900">Место проведения</p>
                                <p class="text-sm text-gray-600">{{ order.venue }}</p>
            </div>
          </div>
          {% endif %}
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="ri-group-line text-gray-400 mr-3 text-lg"></i>
            <div>
                                <p class="text-sm font-medium text-gray-900">Количество гостей</p>
                                <p class="text-sm text-gray-600">{{ order.guest_count }}</p>
            </div>
          </div>
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="ri-money-dollar-circle-line text-gray-400 mr-3 text-lg"></i>
            <div>
                                <p class="text-sm font-medium text-gray-900">Бюджет</p>
                                <p class="text-sm text-gray-600">{{ order.budget }} ₸</p>
            </div>
          </div>
        </div>
      </div>

                <!-- Required Services -->
                {% if order.order_type == 'request' and order.services %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-list-check mr-2 text-blue-600"></i>
                        Требуемые услуги
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          {% for service in order.services %}
                        <div class="flex items-center p-3 bg-blue-50 rounded-lg">
            {% if service_types_dict|get_item:service %}
              {% with service_type=service_types_dict|get_item:service %}
                                    <i class="{{ service_type.icon }} text-blue-600 mr-2"></i>
                                    <span class="text-sm font-medium text-blue-900">{{ service_type.name }}</span>
              {% endwith %}
            {% else %}
                                <i class="ri-checkbox-circle-line text-blue-600 mr-2"></i>
                                <span class="text-sm font-medium text-blue-900">{{ service }}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

                <!-- Selected Tariff -->
      {% if order.order_type == 'booking' and order.tariff %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-price-tag-3-line mr-2 text-blue-600"></i>
                        Выбранный тариф
                    </h2>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">{{ order.tariff.name }}</h3>
                            <span class="text-xl font-bold text-blue-600">{{ order.tariff.price }} ₸</span>
                        </div>
                        <div class="text-gray-600">
                            {{ order.tariff.description|linebreaks }}
                        </div>
        </div>
      </div>
      {% endif %}

                <!-- Description -->
      {% if order.description %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-file-text-line mr-2 text-blue-600"></i>
                        Описание заявки
                    </h2>
                    <div class="prose max-w-none text-gray-700">
          {{ order.description|linebreaks }}
        </div>
      </div>
      {% endif %}

                <!-- Additional Details -->
      {% if order.details %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-file-list-3-line mr-2 text-blue-600"></i>
                        Дополнительные детали
                    </h2>
                    <div class="prose max-w-none text-gray-700">
          {{ order.details|linebreaks }}
        </div>
      </div>
      {% endif %}
      </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Customer Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-user-line mr-2 text-blue-600"></i>
                        Заказчик
                    </h2>
                    <div class="flex items-center mb-4">
            {% if order.customer.profile_photo %}
                            <img src="{{ order.customer.profile_photo.url }}" alt="Фото заказчика" class="w-12 h-12 rounded-full object-cover mr-3">
            {% else %}
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                <i class="ri-user-line text-gray-500"></i>
              </div>
            {% endif %}
                        <div>
                            <p class="font-medium text-gray-900">{{ order.customer.get_full_name|default:"Не указано" }}</p>
                            <p class="text-sm text-gray-600">{{ order.customer.phone_number }}</p>
                </div>
              </div>
                    {% if user.user_type == 'customer' and order.performer %}
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-sm font-medium text-gray-900 mb-2">Исполнитель</h3>
                        <div class="flex items-center">
                            {% if order.performer.profile_photo %}
                                <img src="{{ order.performer.profile_photo.url }}" alt="Фото исполнителя" class="w-10 h-10 rounded-full object-cover mr-3">
                            {% else %}
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                    <i class="ri-user-line text-gray-500"></i>
              </div>
              {% endif %}
                            <div>
                                <p class="font-medium text-gray-900">{{ order.performer.get_full_name }}</p>
                                <p class="text-sm text-gray-600">{{ order.performer.service_type }}</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-settings-3-line mr-2 text-blue-600"></i>
                        Действия
                    </h2>
                    <div class="space-y-3">
                        {% if user.user_type == 'customer' %}
                            {% if order.status == 'pending' %}
                                <button onclick="editOrder()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="ri-edit-line mr-2"></i>
                                    Редактировать
                                </button>
                                <button onclick="cancelOrder()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                                    <i class="ri-close-line mr-2"></i>
                                    Отменить заказ
                                </button>
                            {% elif order.status == 'in_progress' %}
                                <button onclick="completeOrder()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                    <i class="ri-check-line mr-2"></i>
                                    Завершить заказ
                                </button>
                            {% endif %}
                        {% elif user.user_type == 'performer' %}
                            {% if order.status == 'pending' %}
                                <button onclick="respondToOrder()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                    <i class="ri-message-3-line mr-2"></i>
                                    Откликнуться
                                </button>
                            {% elif order.status == 'in_progress' and order.performer == user %}
                                <button onclick="completeOrder()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                    <i class="ri-check-line mr-2"></i>
                                    Завершить заказ
        </button>
      {% endif %}
      {% endif %}

                        <button onclick="openChat()" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <i class="ri-message-2-line mr-2"></i>
                            Открыть чат
          </button>
      </div>
    </div>

                <!-- Order Timeline -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="ri-time-line mr-2 text-blue-600"></i>
                        История заказа
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
      </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Заказ создан</p>
                                <p class="text-sm text-gray-600">{{ order.created_at|date:"d.m.Y H:i" }}</p>
            </div>
          </div>
                        {% if order.status != 'pending' %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-3 h-3 bg-green-600 rounded-full"></div>
          </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Заказ принят в работу</p>
                                <p class="text-sm text-gray-600">{{ order.updated_at|date:"d.m.Y H:i" }}</p>
          </div>
        </div>
                        {% endif %}
                        {% if order.status == 'completed' %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div class="w-3 h-3 bg-green-600 rounded-full"></div>
        </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">Заказ завершен</p>
                                <p class="text-sm text-gray-600">{{ order.completed_at|date:"d.m.Y H:i"|default:order.updated_at|date:"d.m.Y H:i" }}</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
    </div>
    </div>
  </div>
</div>

<script>
function editOrder() {
    window.location.href = "{% url 'main:edit_order' order.id %}";
}

function cancelOrder() {
    if (confirm('Вы уверены, что хотите отменить этот заказ?')) {
        fetch(`/orders/${order.id}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при отмене заказа');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка');
        });
    }
}

function completeOrder() {
    if (confirm('Вы уверены, что хотите завершить этот заказ?')) {
        fetch(`/orders/${order.id}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при завершении заказа');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка');
        });
    }
}

function respondToOrder() {
    window.location.href = "{% url 'main:order_detail' order.id %}#respond";
}

function openChat() {
    // Implement chat functionality
    alert('Функция чата будет добавлена позже');
}
</script>
{% endblock %} 